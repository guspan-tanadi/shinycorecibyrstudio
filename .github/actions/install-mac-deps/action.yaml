name: 'Install macOS brew dependencies'
description: 'Install all brew dependencies given the family tree. This is a poor mans version of package manager until it gets mac support'
author: 'Barret Schloerke'
inputs:
  extra-packages:
    default: ""
    description: String of extra packages
    required: false
runs:
  using: "composite"
  steps:
    - name: Brew dependencies
      shell: Rscript {0}
      run: |
        # Install macOS system dependencies
        if (identical(Sys.getenv("RUNNER_OS", "NOT MAC"), "macOS")) {
          cat("::group::Install macOS system dependencies\n")
          # TODO-future; Find a way to not use `pak`? Hopefully RSPM will handle this in the future
          if (!require("pak")) {
            options(pak.no_extra_messages = TRUE)
            install.packages("pak", repos = "https://r-lib.github.io/p/pak/stable/")
          }
          pkg_deps <- pak::local_dev_deps(dependencies = TRUE)$package
          desc_lines <- tryCatch(paste0(readLines("DESCRIPTION"), collapse = "\n"), error = function(e) "")
          has <- function(pkgs) {
            if (any(pkgs %in% pkg_deps)) return(TRUE)
            for (pkg in pkgs) {
              if (grepl(pkg, "${{ inputs.extra-packages }}", fixed = TRUE)) return(TRUE)
              if (grepl(pkg, desc_lines, fixed = TRUE)) return(TRUE)
            }
            FALSE
          }
          run_cmd <- function(cmd) {
            stopifnot(system(cmd) == 0)
          }
          if (has("Cairo")) {
            run_cmd("brew install --cask xquartz")
            run_cmd("brew install cairo")
          }
          if (has("textshaping")) {
            run_cmd("brew install harfbuzz fribidi")
          }
        }
